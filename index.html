<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/main.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="primary-header row">
        <h1 class="title"><a href="#">#Twittler</a></h1>
      </header>

      <div class="row main">
        <section class="user-col col-1-3">
          <h3 class="user-name">Home</h3>
        </section>

        <section class="tweets col-2-3">
          <div class="tweets-header">
            <h2>Tweets</h2>
            <button class="btn">Refresh</button>
          </div>
          <div id="tweets">
            <!-- Dynamically created -->
          </div>
        </section>
      </div>
      <script>
        $(document).ready(function () {
          var $tweets = $("#tweets");
          var index = 0;
          var tweetSource = streams.home;

          var updateTweets = function () {
            /*
              Function to grab additional tweets from the stream.
              Builds individual tweet and adds to list of tweets
            */
            // get ending index when called
            var end = tweetSource.length;
            var tweet, $tweet, $user, $createDate, $msg;
            // loop through, update tweets
            while (index < end) {
              tweet = tweetSource[index];
              $tweet = $('<div></div>').addClass('tweet');
              $user = $("<a></a>")
                .attr("href", "#")
                .addClass("user")
                .data("user", tweet.user) // data used for filtering
                .text("@" + tweet.user);
              $createDate = $("<span></span>")
                .addClass("created-date")
                .text(tweet.created_at.toLocaleString());
              $msg = $("<p></p>")
                .addClass("tweet-message")
                .text(tweet.message);
              // build tweet
              $tweet.append($user)
                .append($createDate)
                .append($msg);
              $tweet.prependTo($tweets);
              index += 1;
            }
            // update next start index
            index = end;
          };

          var updateUser = function (user) {
            /* Updates username in user-col if username should change */
            var current = $(".user-name").text();
            if (current !== user) {
              $(".user-name").fadeOut(500, function () {
                $(this).text(user);
                $(this).fadeIn(500);
              });
            }
          };

          var filterTweets = function (user) {
            /*
              takes a user and filters the home tweets to only show
              that user's tweets
              Returns user passed in
            */
            // select all tweets that do not belong to the user
            $(".user").filter(function () {
                return $(this).data("user") !== user;
              })
              .closest("div")
              .addClass("hide");

            // changes to tweets header
            $('.tweets-header').find("button").text("Back").addClass("btn-alt");
            return user;
          };

          var showAll = function () {
            /* displays all tweets */
            $tweets.find(".user").closest("div").removeClass("hide");
            // reset tweets header
            $('.tweets-header').find("button").text("Refresh").removeClass("btn-alt");
            // reset user-col
          };

          // jQuery plugin to refresh
          $.fn.refresh = function (queuedFunctions) {
            $(this).addClass("refresh").delay(500).queue(function () {
              queuedFunctions();
              $(this).removeClass("refresh");
              $(this).dequeue();
            });
          };

          var scrollTop = function (e) {
            /* Scrolls user back to top */
            e.preventDefault();
            $('html, body').animate({
              scrollTop: 0
            }, 800);
          };

          /*
            ============================================================
            Event Handlers
            ============================================================
          */
          // Refresh Button
          $('.tweets').on('click', 'button', function (e) {
            $(e.delegateTarget).refresh(function () {
              updateTweets();
              showAll();
            });
            updateUser("Home");
          });

          // filter user
          $('.tweets').on('click', '.user', function (e) {
            scrollTop(e);
            var username = $(this).data("user");
            $(e.delegateTarget).refresh(function () {
              filterTweets(username);
            });
            updateUser("@" + username);
          });

          // scroll to top
          $(".primary-header").on('click', '.title', scrollTop);

          // initial run
          updateTweets();
        });
      </script>
    </div>
  </body>
</html>

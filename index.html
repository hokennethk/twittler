<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/main.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="primary-header row">
        <h1 class="title"><a href="#">#Twittler</a></h1>
      </header>

      <div class="row main">
        <section class="user-col col-1-3">
          <h3 class="user-name">Home</h3>
        </section>

        <section class="tweets col-2-3">
          <div class="tweets-header">
            <h2>Tweets</h2>
            <button class="btn">Refresh</button>
          </div>
          <div id="tweets">
            <!-- Dynamically created -->
          </div>
        </section>
      </div>
      <script>

        $(document).ready(function(){
          var $body = $('body');
          var $tweets = $("#tweets");
          var $main = $("div.main");
          var $userCol = $(".user-col");
          var currentUser;
          var start = 0;
          var tweetSource = streams.home;
          /* Original Code... may reuse
          // $body.html('');

          // var index = streams.home.length - 1;
          // while(index >= 0){
          //   var tweet = streams.home[index];
          //   var $tweet = $('<div></div>');
          //   $tweet.text('@' + tweet.user + ': ' + tweet.message);
          //   $tweet.appendTo($tweets);
          //   index -= 1;
          // }
          */


          var updateTweets = function() {
              // get ending index when called
              var end = tweetSource.length;
              // loop through, update tweets
              for (var i = start; i < end; i ++) {
                var tweet = tweetSource[i];
                var $tweet = $('<div></div>')
                              .addClass('tweet');
                var $user = $("<a></a>")
                            .attr("href", "#")
                            .addClass("user")
                            .data("user", tweet.user) // data used for filtering
                            .text("@" + tweet.user);
                var $createDate = $("<span></span>")
                                  .addClass("created-date")
                                  .text(tweet.created_at.toLocaleString());
                var $msg = $("<p></p>")
                            .addClass("tweet-message")
                            .text(tweet.message);
                // build tweet
                $tweet.append($user)
                      .append($createDate)
                      .append("<p>" + tweet.message + "</p>");
                $tweet.prependTo($tweets);
              }
              // update next start index
              start = end;
            };

          // update user column
          var updateUser = function(user) {
            $(".user-name").fadeOut(500, function () {
              $(this).text(user);
              $(this).fadeIn(500);
            });
          };

          var filterTweets = function(user) {
            /* takes a user and filters the home tweets to only show
            that user's tweets
            Returns user passed in */
            // select all tweets that do not belong to the user
            var $toHide = $(".user")
                          .filter(function() {
                            return $(this).data("user") !== user;
                          })
                          .closest("div");
            $toHide.addClass("hide");

            // changes to tweets header
            $('.tweets-header').find("button").text("Back").addClass("btn-alt");
            return user;
          };

          var showAll = function() {
            /* displays all tweets */
            $tweets.find(".user").closest("div").removeClass("hide");
            // reset tweets header
            $('.tweets-header').find("button").text("Refresh").removeClass("btn-alt");
            // reset user-col
          };

          updateTweets();

          // Refresh Button
          $('.tweets').on('click', 'button', function(e) {
            // $main.addClass("hide");
            $(e.delegateTarget).addClass("refresh")
                                .delay(500)
                                .queue(function () {
                                  updateTweets();
                                  showAll();
                                  $(this).removeClass("refresh");
                                  $(this).dequeue();
                                });
            updateUser("Home");
          });

          // callback function for scroll to top
          var scrollTop = function(e) {
            e.preventDefault();
            $('html, body').animate({
              scrollTop: 0
            }, 800);
          };

          // filter user
          $('.tweets').on('click', '.user', function(e) {
            scrollTop(e);
            var username = $(this).data("user");
            $(e.delegateTarget).addClass("refresh")
                                .delay(500)
                                .queue(function () {
                                  // filter tweets and set currentUser
                                  currentUser = filterTweets(username);
                                  $(this).removeClass("refresh");
                                  $(this).dequeue();
                                });
            updateUser("@" + username);
          });

          // bind scroll to top
          $(".primary-header").on('click', '.title', scrollTop);

        });

      </script>
    </div>
  </body>
</html>
